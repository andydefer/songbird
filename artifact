#!/usr/bin/env php
<?php

require_once __DIR__ . '/vendor/autoload.php';

use AndyDefer\Songbird\Contracts\CommandInterface;

class ArtifactCli
{
    /** @var array<string, CommandInterface> */
    private array $commands = [];

    public function __construct(array $commandClasses)
    {
        $this->registerCommands($commandClasses);
    }

    /**
     * Enregistre toutes les commandes depuis les classes configurées
     */
    private function registerCommands(array $commandClasses): void
    {
        foreach ($commandClasses as $commandClass) {
            if (!class_exists($commandClass)) {
                echo "Attention: La classe {$commandClass} n'existe pas.\n";
                continue;
            }

            if (!is_subclass_of($commandClass, CommandInterface::class)) {
                echo "Attention: {$commandClass} doit implémenter CommandInterface.\n";
                continue;
            }

            /** @var CommandInterface $command */
            $command = new $commandClass();
            $this->commands[$command->getName()] = $command;
        }
    }

    public function run(array $argv): void
    {
        if (count($argv) < 2) {
            $this->showHelp();
            exit(1);
        }

        $commandName = $argv[1];
        $arguments = array_slice($argv, 2);

        if (!isset($this->commands[$commandName])) {
            echo "Commande inconnue: {$commandName}\n";
            $this->showHelp();
            exit(1);
        }

        try {
            $this->commands[$commandName]->execute($arguments);
        } catch (Exception $e) {
            echo "Erreur lors de l'exécution: " . $e->getMessage() . "\n";
            exit(1);
        }
    }

    private function showHelp(): void
    {
        echo "Artifact CLI - Outil de génération de code\n\n";
        echo "Usage: php artifact <commande> [arguments...]\n\n";
        echo "Commandes disponibles:\n";

        foreach ($this->commands as $command) {
            echo sprintf(
                "  %-20s %s\n",
                $command->getName(),
                $command->getDescription()
            );
        }

        echo "\nPour plus d'informations sur une commande:\n";
        echo "  php artifact <commande> --help\n\n";
        echo "Exemples:\n";
        echo "  php artifact make:test Unit/ExampleTest\n";
        echo "  php artifact make:test Feature/UserTest\n";
    }
}

// Point d'entrée de l'application
if (PHP_SAPI === 'cli') {
    // Charger la configuration des commandes
    $commandsConfig = require __DIR__ . '/config/commands.php';

    $cli = new ArtifactCli($commandsConfig);
    $cli->run($argv);
} else {
    echo "Ce script doit être exécuté en ligne de commande.\n";
    exit(1);
}
